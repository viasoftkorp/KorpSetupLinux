---
- name: Setup main
  hosts: 127.0.0.1
  connection: local
  vars:
    ansible_become_password: "{{ linux_korp.password }}"
  become_user: "{{ linux_korp.user }}"
  become: true

  tasks:
    - name: Execução de playbook
      block:
        - name: Default setup
          ansible.builtin.import_role:
            name: utils
            tasks_from: default_setup
          tags:
            - always

        - name: Infrastructure
          ansible.builtin.import_role:
            name: infrastructure
          tags:
            - infrastructure
            - default-setup

        - name: Infrastructure-web
          ansible.builtin.import_role:
            name: infrastructure-web
          tags:
            - infrastructure-web
            - default-setup

        - name: Infrastructure-desktop
          ansible.builtin.import_role:
            name: infrastructure-desktop
          tags:
            - infrastructure-desktop
            - default-setup

        - name: REL01
          ansible.builtin.import_role:
            name: REL01
          tags:
            - REL01
            - default-setup

        # task utiliza parâmetros passados por --extra-vars='{"apps":[<app1>,<app2>,...]}'
        - name: 
          ansible.builtin.import_role:
            name: "{{ item }}"
          loop: "{{ apps }}"
          loop_control:
            loop_var: app_name
          tags: install-apps

        # task executa update para a versão '{{ version_without_build }}', utilizando os APPs em '{{ config_dir_path }}/korp_services.yml'
        - name:
          ansible.builtin.include_role:
            name: utils
            tasks_from: apps_update/main.yml
          tags: update

        # essa deve ser a ultima task
        - name: Finishing
          ansible.builtin.import_role:
            name: finishing
          tags:
            - finishing
            - always

      # bloco só será executado caso ocorra algum erro
      rescue:
        - name: Tratativa de erro
          ansible.builtin.import_role:
            name: finishing
            tasks_from: error
          tags:
            - always
