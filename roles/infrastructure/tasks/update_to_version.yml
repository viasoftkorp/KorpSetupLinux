- name: Subir RabbitMQ nas versão
  ansible.builtin.shell:
    "docker run --name rabbitmq{{ item }} -d -p 5672:5672 -p 15672:15672 -v {{ dados_docker_dir_path }}/{{ rabbitmq_container_name }}:/var/lib/rabbitmq rabbitmq:{{ item }}-management"
  register: new_container_raw_result

- name: Aguarda inicialização do rabbitmq
  community.docker.docker_container_exec:
    container: rabbitmq{{ item }}
    command: |
      rabbitmqctl await_startup
    chdir: /
  register: result
  retries: 5
  delay: 5
  until: result is not failed

- name: Obtenção de id do novo container
  ansible.builtin.set_fact:
    rabbitmq_container_id: "{{ new_container_raw_result.stdout }}"

- name: Aguarda inicialização do rabbitmq
  community.docker.docker_container_exec:
    container: rabbitmq{{ item }}
    command: |
      rabbitmqctl enable_feature_flag all
    chdir: /
  register: result
  retries: 5
  delay: 5
  until: result is not failed

- name: Remoção de container do RabbitMQ desatualizado
  ansible.builtin.shell:
    docker rm -f {{ rabbitmq_container_id }}


