- name: configuração e transferência de arquivos de compose de infrastructure-web
  ansible.builtin.template:
    dest: "{{ korp_dir_path }}/composes/{{ item[:-3] | basename }}"
    src: "composes/{{ item | basename }}"
    owner: "{{ linux_korp.user }}"
    group: root
    mode: '0644'
  loop:
    "{{ lookup('fileglob', 'templates/composes/*', wantlist=True) | select('search','.yml.j2') }}"

# precisa estar antes do Viasoft.Authentication, pois o mesmo cria os clients a partir do Consul
- name: adição de serviços de infrastructure-web
  ansible.builtin.include_role:
    name: utils
    tasks_from: services/add_service
  vars:
    service_name: "{{ item.key }}"
    id: infrastructure-web
    skip_compose: true
  with_dict: "{{ (lookup('file', 'vars/main.yml') | from_yaml)['services'] }}"
  loop_control:
    extended: true

- name: setup Viasoft.Authentication
  ansible.builtin.import_tasks: authentication.yml

- name: adição de serviços
  ansible.builtin.include_role:
    name: utils
    tasks_from: services/manual_service_addition
  vars:
    service_name: "{{ item }}"
  loop:
    - Korp.Legacy.Administration
    - Korp.Legacy.Authorization

- name: criação e inicialização de compose de infraestrutura WEB
  community.docker.docker_compose:
    project_src: "{{ korp_dir_path }}/composes/"
    env_file: "{{ docker_env_file_path }}"
    files:
      - infrastructure-web-compose.yml
